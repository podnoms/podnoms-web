version: 2.0
general:
  branches:
    only:
      - master
      - develop
jobs:
    login:
        docker:
          - image: circleci/buildpack-deps:18.04-curl-browsers
        steps:
            - setup_remote_docker
            - run: docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD $DOCKER_REGISTRY

    build:
        docker:
          - image: circleci/buildpack-deps:18.04-curl-browsers
        steps:
            - checkout
            - setup_remote_docker
            - run: docker build -t podnoms.azurecr.io/podnoms.api .

    build_and_deploy:
        docker:
          - image: circleci/buildpack-deps:18.04-curl-browsers
        filters:
            branches:
                only: develop
        steps:
            - checkout
            - setup_remote_docker
            - run: docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD $DOCKER_REGISTRY
            - run: docker build -t podnoms.azurecr.io/podnoms.api .
            - run: docker push podnoms.azurecr.io/podnoms.api
workflows:
    version: 2
    build-test-deploy:
        jobs:
            - login
            - build:
                filters:
                    branches:
                        only: develop
                requires:
                  - login
            - build_and_deploy:
                filters:
                    branches:
                        only: master
                requires:
                    - login
